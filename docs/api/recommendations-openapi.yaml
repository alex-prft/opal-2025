openapi: 3.0.3
info:
  title: OPAL Decision Layer API
  description: |
    Enterprise decision-making API that processes OPAL agent outputs to generate
    intelligent recommendations with evidence, confidence scoring, and impact/effort analysis.

    This API integrates with the OPAL workflow system to provide data-driven
    decision support for digital experience optimization.
  version: 1.0.0
  contact:
    name: OPAL Development Team
    url: https://opal-2025.vercel.app
  license:
    name: MIT

servers:
  - url: http://localhost:3000
    description: Local development server
  - url: https://opal-2025.vercel.app
    description: Production server

paths:
  /api/recommendations:
    post:
      tags:
        - Decision Layer
      summary: Generate Recommendations
      description: |
        Generate intelligent recommendations based on OPAL agent outputs and user preferences.

        This endpoint processes workflow data from 9 OPAL agents and applies decision-making
        logic to provide prioritized recommendations with evidence and confidence scoring.
      operationId: generateRecommendations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DecisionParameters'
            example:
              workflow_id: "wf-conversion-optimization-2024"
              preferences:
                priority_weights:
                  impact: 0.7
                  effort: 0.3
                risk_tolerance: "medium"
                business_objectives: ["conversion", "engagement"]
                timeline_constraints:
                  start_date: "2025-11-12T00:00:00Z"
                  end_date: "2025-12-12T00:00:00Z"
      responses:
        '200':
          description: Successfully generated recommendations
          headers:
            X-Correlation-ID:
              schema:
                type: string
              description: Request correlation ID for tracing
            X-Response-Time:
              schema:
                type: string
              description: Processing time in milliseconds
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardApiResponse'
              example:
                success: true
                data:
                  workflow_id: "wf-conversion-optimization-2024"
                  workflow_state: "in-progress"
                  recommendations:
                    - id: "rec-1699876543210-abc123"
                      title: "Optimize Call-to-Action Placement"
                      description: "Move primary CTAs above the fold to increase visibility and conversions"
                      impact: 8
                      effort: 3
                      combined_ratio: 2.67
                      confidence: 0.89
                      confidence_breakdown:
                        data_quality: 0.91
                        agent_consensus: 0.87
                      category: "High"
                      evidence:
                        - agent_type: "content_review"
                          data_source: "Content Management System"
                          confidence: 0.91
                          timestamp: "2025-11-12T10:00:00Z"
                          summary: "Content analysis identifies engagement improvement areas"
                      tags: ["CTA", "conversion optimization", "UX"]
                      estimated_timeline: "2 weeks (2025-11-12 to 2025-11-26)"
                      risk_level: "low"
                  metadata:
                    total_recommendations: 1
                    generated_at: "2025-11-12T15:45:00.000Z"
                    processing_time_ms: 245
                correlation_id: "api-1699876543210-def456"
                timestamp: "2025-11-12T15:45:00.000Z"
                duration_ms: 245
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "VALIDATION_ERROR"
                message: "Invalid request body"
                correlation_id: "api-1699876543210-def456"
                timestamp: "2025-11-12T15:45:00.000Z"
        '404':
          description: Workflow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds to wait before retrying
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      tags:
        - Documentation
      summary: API Documentation
      description: Returns API documentation, sample requests, and supported parameters
      operationId: getApiDocumentation
      responses:
        '200':
          description: API documentation and examples
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiDocumentation'

components:
  schemas:
    DecisionParameters:
      type: object
      required:
        - workflow_id
        - preferences
      properties:
        workflow_id:
          type: string
          description: Unique identifier for the OPAL workflow
          example: "wf-conversion-optimization-2024"
        preferences:
          $ref: '#/components/schemas/DecisionPreferences'

    DecisionPreferences:
      type: object
      required:
        - priority_weights
        - risk_tolerance
        - business_objectives
        - timeline_constraints
      properties:
        priority_weights:
          $ref: '#/components/schemas/PriorityWeights'
        risk_tolerance:
          type: string
          enum: [low, medium, high]
          description: Risk tolerance level for recommendations
          example: "medium"
        business_objectives:
          type: array
          items:
            type: string
            enum: [conversion, retention, engagement, acquisition, revenue, personalization, experience, performance]
          minItems: 1
          description: Business objectives to optimize for
          example: ["conversion", "engagement"]
        timeline_constraints:
          $ref: '#/components/schemas/TimelineConstraints'

    PriorityWeights:
      type: object
      required:
        - impact
        - effort
      properties:
        impact:
          type: number
          minimum: 0
          maximum: 1
          description: Weight for impact scoring (must sum with effort to 1.0)
          example: 0.7
        effort:
          type: number
          minimum: 0
          maximum: 1
          description: Weight for effort scoring (must sum with impact to 1.0)
          example: 0.3

    TimelineConstraints:
      type: object
      required:
        - start_date
        - end_date
      properties:
        start_date:
          type: string
          format: date-time
          description: Project start date (ISO 8601 format)
          example: "2025-11-12T00:00:00Z"
        end_date:
          type: string
          format: date-time
          description: Project end date (ISO 8601 format)
          example: "2025-12-12T00:00:00Z"

    Recommendation:
      type: object
      required:
        - title
        - impact
        - effort
        - combined_ratio
        - confidence
        - confidence_breakdown
        - evidence
      properties:
        id:
          type: string
          description: Unique recommendation identifier
          example: "rec-1699876543210-abc123"
        title:
          type: string
          description: Recommendation title
          example: "Optimize Call-to-Action Placement"
        description:
          type: string
          description: Detailed recommendation description
          example: "Move primary CTAs above the fold to increase visibility and conversions"
        impact:
          type: integer
          minimum: 1
          maximum: 10
          description: Expected impact score (1-10 scale)
          example: 8
        effort:
          type: integer
          minimum: 1
          maximum: 10
          description: Implementation effort score (1-10 scale)
          example: 3
        combined_ratio:
          type: number
          minimum: 0
          description: Impact to effort ratio (impact / effort)
          example: 2.67
        confidence:
          type: number
          minimum: 0
          maximum: 1
          description: Overall confidence score (0-1 scale)
          example: 0.89
        confidence_breakdown:
          $ref: '#/components/schemas/ConfidenceBreakdown'
        category:
          type: string
          enum: [High, Medium, Low]
          description: Priority category based on impact/effort ratio
          example: "High"
        evidence:
          type: array
          items:
            $ref: '#/components/schemas/EvidenceItem'
          minItems: 1
          description: Supporting evidence from OPAL agents
        tags:
          type: array
          items:
            type: string
          description: Recommendation tags
          example: ["CTA", "conversion optimization", "UX"]
        estimated_timeline:
          type: string
          description: Estimated implementation timeline
          example: "2 weeks (2025-11-12 to 2025-11-26)"
        risk_level:
          type: string
          enum: [low, medium, high]
          description: Assessed risk level for this recommendation
          example: "low"

    ConfidenceBreakdown:
      type: object
      required:
        - data_quality
        - agent_consensus
      properties:
        data_quality:
          type: number
          minimum: 0
          maximum: 1
          description: Quality of underlying data (0-1 scale)
          example: 0.91
        agent_consensus:
          type: number
          minimum: 0
          maximum: 1
          description: Level of agreement between agents (0-1 scale)
          example: 0.87

    EvidenceItem:
      type: object
      required:
        - agent_type
        - data_source
        - confidence
        - timestamp
        - summary
      properties:
        agent_type:
          type: string
          enum: [experiment_blueprinter, audience_suggester, content_review, roadmap_generator, integration_health, personalization_idea_generator, cmp_organizer, customer_journey, geo_audit]
          description: OPAL agent that provided this evidence
          example: "content_review"
        data_source:
          type: string
          description: Source system or database
          example: "Content Management System"
        confidence:
          type: number
          minimum: 0
          maximum: 1
          description: Confidence level of this evidence (0-1 scale)
          example: 0.91
        timestamp:
          type: string
          format: date-time
          description: When this evidence was collected (ISO 8601 format)
          example: "2025-11-12T10:00:00Z"
        summary:
          type: string
          maxLength: 500
          description: Brief summary of the evidence
          example: "Content analysis identifies engagement improvement areas"

    StandardApiResponse:
      type: object
      required:
        - success
        - correlation_id
        - timestamp
      properties:
        success:
          type: boolean
          description: Whether the request was successful
          example: true
        data:
          description: Response data (varies by endpoint)
        message:
          type: string
          description: Optional human-readable message
        correlation_id:
          type: string
          description: Unique request identifier for tracing
          example: "api-1699876543210-def456"
        timestamp:
          type: string
          format: date-time
          description: Response generation timestamp (ISO 8601 format)
          example: "2025-11-12T15:45:00.000Z"
        duration_ms:
          type: integer
          minimum: 0
          description: Processing time in milliseconds
          example: 245

    ErrorResponse:
      type: object
      required:
        - success
        - error
        - message
        - correlation_id
        - timestamp
      properties:
        success:
          type: boolean
          description: Always false for error responses
          example: false
        error:
          type: string
          description: Error code
          example: "VALIDATION_ERROR"
        message:
          type: string
          description: Human-readable error description
          example: "Invalid request body"
        correlation_id:
          type: string
          description: Unique request identifier for tracing
          example: "api-1699876543210-def456"
        timestamp:
          type: string
          format: date-time
          description: Error occurrence timestamp (ISO 8601 format)
          example: "2025-11-12T15:45:00.000Z"
        duration_ms:
          type: integer
          minimum: 0
          description: Processing time before error occurred
          example: 25
        data:
          description: Additional error details (only in development)

    ApiDocumentation:
      type: object
      properties:
        endpoint:
          type: string
          example: "/api/recommendations"
        description:
          type: string
        version:
          type: string
          example: "1.0.0"
        methods:
          type: object
        features:
          type: array
          items:
            type: string
        agent_types:
          type: array
          items:
            type: string
        business_objectives:
          type: array
          items:
            type: string
        risk_tolerance_levels:
          type: array
          items:
            type: string
        sample_curl:
          type: string

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: Bearer token authentication (when implemented)

  responses:
    ValidationError:
      description: Request validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    RateLimitExceeded:
      description: Too many requests
      headers:
        Retry-After:
          schema:
            type: integer
          description: Seconds to wait before retrying
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

tags:
  - name: Decision Layer
    description: Intelligent recommendation generation based on OPAL agent outputs
  - name: Documentation
    description: API documentation and examples