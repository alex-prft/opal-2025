# OSA Supabase Guardrails Implementation Guide\n\n## Overview\n\nThis document outlines the comprehensive Supabase data governance system implemented for OSA (Optimizely Strategy Assistant). The guardrails ensure compliance with data protection requirements while maintaining system performance and usability.\n\n## ‚úÖ Implementation Summary\n\n### What Supabase SHOULD Store:\n- ‚úÖ **Configuration Data**: OPAL mappings, service dependencies, microservice configurations\n- ‚úÖ **System Settings**: Application preferences, feature flags, operational parameters\n- ‚úÖ **Aggregated/Anonymous Metrics**: Usage statistics, performance data (no individual customer details)\n- ‚úÖ **Customer Configuration Preferences**: Theme, dashboard layout, notification settings (non-PII)\n- ‚úÖ **OPAL Agent Configurations**: Customer-specific agent settings and workflows\n- ‚úÖ **A/B Testing Configurations**: Test parameters that may reference customer segments\n- ‚úÖ **Metadata About Insights**: Workflow execution logs, agent performance metrics (anonymized)\n- ‚úÖ **Audit Logs**: Security events, access logs, compliance monitoring\n\n### What Supabase MUST NOT Store:\n- ‚ùå **PII Information**: Names, emails, phone numbers, addresses\n- ‚ùå **Direct Customer Analytics**: Individual behavior data, personal insights\n- ‚ùå **API Keys**: External service credentials (use external secret management)\n- ‚ùå **Actual Customer Data**: Raw CRM data, personal profiles\n- ‚ùå **Salesforce/CRM Leads**: Process but never persist customer records\n\n## üèóÔ∏è Architecture Components\n\n### 1. Core Guardrails Manager (`supabase-guardrails.ts`)\n- **PII Detection**: Real-time scanning with comprehensive patterns\n- **Data Classification**: Automatic categorization (configuration, metadata, anonymous_metrics, temporary, restricted)\n- **Operation Validation**: Pre-execution checks for all database operations\n- **Schema-Level Policies**: Database triggers and functions for protection\n\n### 2. Secure Client Wrapper (`supabase-secure-client.ts`)\n- **Transparent Security**: Drop-in replacement for standard Supabase client\n- **Automatic Validation**: All operations validated before execution\n- **Audit Integration**: Built-in logging for all database activities\n- **Query Builder Protection**: Maintains security context through query chains\n\n### 3. Data Retention Manager (`data-retention-manager.ts`)\n- **Automated Cleanup**: Configurable retention periods by data type\n- **Multiple Purge Methods**: Delete, anonymize, or archive expired data\n- **Backup Integration**: Automatic backup creation before deletion\n- **Compliance Reporting**: Detailed audit trails of retention activities\n\n### 4. Audit System (`audit-system.ts`)\n- **Real-time Logging**: Batched audit event processing\n- **Compliance Reporting**: Automated generation of compliance reports\n- **Security Monitoring**: Detection and alerting for suspicious activities\n- **Performance Tracking**: Database operation metrics and optimization insights\n\n### 5. Configuration Validator (`configuration-validator.ts`)\n- **Schema Validation**: Zod-based validation for all configuration data\n- **Middleware Integration**: Next.js API route middleware\n- **Session Management**: Automatic token expiration and security handling\n- **A/B Test Protection**: Special validation for testing configurations\n\n## üìä Data Classification System\n\n```typescript\nexport const DATA_GOVERNANCE_RULES = {\n  configuration: {\n    // Forever retention, full CRUD operations\n    allowedTables: ['opal_configurations', 'opal_agent_configs', 'system_settings']\n  },\n  metadata: {\n    // 365-day retention, limited operations\n    allowedTables: ['opal_workflow_executions', 'agent_performance_metrics']\n  },\n  anonymous_metrics: {\n    // 365-day retention, no PII scanning needed\n    allowedTables: ['anonymous_usage_metrics', 'performance_analytics']\n  },\n  temporary: {\n    // 7-day retention, automatic cleanup\n    allowedTables: ['session_states', 'temporary_workflow_data']\n  },\n  restricted: {\n    // No operations allowed, blocks customer data\n    allowedTables: [] // Empty - these shouldn't exist in Supabase\n  }\n};\n```\n\n## üöÄ Quick Start Integration\n\n### 1. Replace Existing Supabase Usage\n\n**Before:**\n```typescript\nimport { supabase } from '@/lib/supabase';\n\nconst { data, error } = await supabase\n  .from('opal_workflow_executions')\n  .insert(workflowData);\n```\n\n**After:**\n```typescript\nimport { secureSupabase } from '@/lib/database';\n\nconst { data, error } = await secureSupabase\n  .from('opal_workflow_executions')\n  .insert(workflowData, { \n    classification: 'metadata',\n    auditContext: 'workflow_creation'\n  });\n```\n\n### 2. Add Validation to API Routes\n\n```typescript\n// middleware.ts\nimport { createSupabaseValidationMiddleware } from '@/lib/database';\n\nexport const middleware = createSupabaseValidationMiddleware();\n\n// api/opal/workflows/route.ts\nexport async function POST(req: Request) {\n  const validation = await req.validateSupabaseOperation({\n    table: 'opal_workflow_executions',\n    operation: 'write',\n    data: await req.json()\n  });\n  \n  if (!validation.allowed) {\n    return NextResponse.json(\n      { error: validation.reason },\n      { status: 403 }\n    );\n  }\n  \n  // Proceed with validated, sanitized data\n  const result = await secureSupabase\n    .from('opal_workflow_executions')\n    .insert(validation.sanitizedData);\n}\n```\n\n### 3. Initialize System on Startup\n\n```typescript\n// app/layout.tsx or startup file\nimport { initializeGuardrails } from '@/lib/database';\n\nexport default async function RootLayout() {\n  await initializeGuardrails();\n  // ... rest of app\n}\n```\n\n## üìù Configuration Examples\n\n### Session Token Management\n```typescript\n// Automatic expiration and encryption\nconst sessionData = {\n  user_id: 'user_123',\n  token: 'raw_session_token', // Will be encrypted automatically\n  // expires_at will be set to 24 hours from now if not provided\n};\n\nawait secureSupabase\n  .from('session_states')\n  .insert(sessionData, { classification: 'temporary' });\n```\n\n### OPAL Agent Configuration\n```typescript\nconst agentConfig = {\n  name: 'content-optimizer',\n  type: 'content',\n  configuration: {\n    model: 'gpt-4',\n    parameters: { creativity: 0.7 },\n    rate_limits: {\n      requests_per_minute: 60,\n      concurrent_requests: 3\n    }\n  },\n  enabled: true\n};\n\nawait secureSupabase\n  .from('opal_agent_configs')\n  .insert(agentConfig, { classification: 'configuration' });\n```\n\n### Anonymous Metrics Collection\n```typescript\nconst metric = {\n  metric_type: 'feature_adoption',\n  aggregation_level: 'daily',\n  dimensions: { feature: 'workflow_optimizer' },\n  value: 1,\n  timestamp: new Date().toISOString()\n};\n\nawait secureSupabase\n  .from('anonymous_usage_metrics')\n  .insert(metric, { classification: 'anonymous_metrics' });\n```\n\n## üîç Monitoring and Compliance\n\n### Health Checks\n```typescript\nimport { checkGuardrailsHealth } from '@/lib/database';\n\nconst health = await checkGuardrailsHealth();\nif (health.status === 'critical') {\n  // Alert operations team\n  console.error('Guardrails system critical:', health.checks);\n}\n```\n\n### Compliance Reports\n```typescript\nimport { auditSystem } from '@/lib/database';\n\n// Generate monthly compliance report\nconst report = await auditSystem.generateComplianceReport({\n  period: {\n    start: new Date('2024-01-01'),\n    end: new Date('2024-01-31')\n  },\n  includeRecommendations: true,\n  format: 'json'\n});\n\nconsole.log(`Compliance Score: ${report.summary.compliance_score}%`);\n```\n\n### Data Retention Status\n```typescript\nimport { dataRetentionManager } from '@/lib/database';\n\n// Check what data is eligible for cleanup\nconst status = await dataRetentionManager.getRetentionStatus();\nstatus.forEach(table => {\n  if (table.eligibleForPurge > 0) {\n    console.log(`${table.table}: ${table.eligibleForPurge} records ready for cleanup`);\n  }\n});\n```\n\n## ‚öôÔ∏è Scheduled Tasks\n\n### Automated Data Retention (Recommended: Daily)\n```typescript\n// Add to your cron job or scheduled task system\nimport { runScheduledRetention } from '@/lib/database';\n\n// Run daily at 2 AM\nconst cronJob = new CronJob('0 2 * * *', async () => {\n  await runScheduledRetention();\n});\n```\n\n### Manual Retention Execution\n```typescript\nimport { dataRetentionManager } from '@/lib/database';\n\n// Dry run to see what would be deleted\nconst dryRunResult = await dataRetentionManager.executeRetentionPolicies(true);\nconsole.log('Would delete:', dryRunResult.totalRecordsAffected, 'records');\n\n// Actual execution\nconst result = await dataRetentionManager.executeRetentionPolicies(false);\nconsole.log('Deleted:', result.totalRecordsAffected, 'records');\n```\n\n## üõ°Ô∏è Security Features\n\n### PII Detection Patterns\n- **Email addresses**: `[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}`\n- **Phone numbers**: US/International formats\n- **SSN**: `\\d{3}-?\\d{2}-?\\d{4}`\n- **Credit cards**: Standard patterns\n- **IP addresses**: IPv4 patterns\n- **Names**: Basic first/last name patterns\n- **Addresses**: Street address patterns\n\n### Schema-Level Protection\n```sql\n-- Automatically created database triggers\nCREATE OR REPLACE FUNCTION prevent_pii_insertion()\nRETURNS TRIGGER AS $$\nBEGIN\n    -- Scan for PII patterns and block insertion\n    -- Detailed implementation in supabase-guardrails.ts\nEND;\n$$ LANGUAGE plpgsql;\n```\n\n### Audit Event Types\n- `DATABASE_OPERATION`: All CRUD operations\n- `PII_VIOLATION`: Detected PII in data\n- `SECURITY_EVENT`: Authentication, authorization issues\n- `CONFIGURATION_CHANGE`: System setting modifications\n- `COMPLIANCE_CHECK`: Automated compliance validations\n- `DATA_RETENTION`: Cleanup and purging activities\n\n## üö® Migration Path\n\nFor existing OSA installations:\n\n1. **Install Guardrails**: Add the new files to your project\n2. **Update Imports**: Gradually replace `supabase` with `secureSupabase`\n3. **Add Validation**: Implement validation middleware for API routes\n4. **Configure Retention**: Set up scheduled data cleanup\n5. **Monitor**: Use health checks and compliance reports\n\nThe system is designed for gradual migration - existing code will continue to work while you adopt the new security measures.\n\n## üìû Support and Troubleshooting\n\n### Common Issues\n\n1. **PII Violation Errors**: Check data for email patterns, phone numbers, or names\n2. **Schema Validation Failures**: Ensure data matches expected format for configuration types\n3. **Retention Policy Conflicts**: Verify table classifications align with retention rules\n4. **Performance Issues**: Monitor audit logs for slow operations, consider query optimization\n\n### Debug Mode\n```typescript\n// Enable detailed logging\nprocess.env.SUPABASE_GUARDRAILS_DEBUG = 'true';\n\n// Check specific table classification\nconst classification = supabaseGuardrails.classifyTable('your_table');\nconsole.log('Table classification:', classification);\n```\n\nThis comprehensive guardrails system ensures OSA maintains the highest standards of data protection while enabling powerful Optimizely integration and workflow automation.