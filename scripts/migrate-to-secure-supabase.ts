#!/usr/bin/env npx ts-node\n\n/**\n * Migration Script: Convert Raw Supabase Usage to Secure Client\n * \n * This script analyzes the codebase and provides a migration plan\n * for converting existing Supabase operations to use the secure client.\n */\n\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport { glob } from 'glob';\n\ninterface SupabaseUsage {\n  file: string;\n  line: number;\n  code: string;\n  table?: string;\n  operation?: string;\n  migrationSuggestion: string;\n}\n\nconst SUPABASE_PATTERNS = [\n  {\n    pattern: /supabase\\.from\\(['\"`]([^'\"`)]+)['\"`]\\)\\.insert\\(/g,\n    operation: 'insert',\n    replacement: 'secureSupabase.from(\"$1\").insert(data, { classification: \"auto-detected\" })'\n  },\n  {\n    pattern: /supabase\\.from\\(['\"`]([^'\"`)]+)['\"`]\\)\\.update\\(/g,\n    operation: 'update',\n    replacement: 'secureSupabase.from(\"$1\").update(data, { classification: \"auto-detected\" })'\n  },\n  {\n    pattern: /supabase\\.from\\(['\"`]([^'\"`)]+)['\"`]\\)\\.delete\\(/g,\n    operation: 'delete',\n    replacement: 'secureSupabase.from(\"$1\").delete({ classification: \"auto-detected\" })'\n  },\n  {\n    pattern: /supabase\\.from\\(['\"`]([^'\"`)]+)['\"`]\\)\\.select\\(/g,\n    operation: 'select',\n    replacement: 'secureSupabase.from(\"$1\").select(columns, { classification: \"auto-detected\" })'\n  },\n  {\n    pattern: /supabase\\.from\\(['\"`]([^'\"`)]+)['\"`]\\)\\.upsert\\(/g,\n    operation: 'upsert',\n    replacement: 'secureSupabase.from(\"$1\").upsert(data, { classification: \"auto-detected\" })'\n  },\n  {\n    pattern: /supabase\\.rpc\\(['\"`]([^'\"`)]+)['\"`]/g,\n    operation: 'rpc',\n    replacement: 'secureSupabase.rpc(\"$1\", params, { classification: \"auto-detected\" })'\n  }\n];\n\nconst TABLE_CLASSIFICATIONS: Record<string, string> = {\n  'opal_configurations': 'configuration',\n  'opal_agent_configs': 'configuration',\n  'opal_tool_registry': 'configuration',\n  'system_settings': 'configuration',\n  'user_preferences': 'configuration',\n  \n  'opal_workflow_executions': 'metadata',\n  'opal_agent_executions': 'metadata',\n  'workflow_metadata': 'metadata',\n  'supabase_audit_log': 'metadata',\n  \n  'session_states': 'temporary',\n  'temporary_workflow_data': 'temporary',\n  'cache_invalidation_queue': 'temporary',\n  \n  'anonymous_usage_metrics': 'anonymous_metrics',\n  'performance_analytics': 'anonymous_metrics',\n  'system_health_metrics': 'anonymous_metrics'\n};\n\nclass SupabaseMigrator {\n  private usages: SupabaseUsage[] = [];\n  private sourceDir: string;\n  \n  constructor(sourceDir = 'src') {\n    this.sourceDir = sourceDir;\n  }\n  \n  async analyzeCodebase(): Promise<void> {\n    console.log('üîç Analyzing codebase for Supabase usage...');\n    \n    // Find all TypeScript and JavaScript files\n    const files = await glob(`${this.sourceDir}/**/*.{ts,tsx,js,jsx}`, {\n      ignore: ['**/node_modules/**', '**/dist/**', '**/.next/**']\n    });\n    \n    console.log(`Found ${files.length} files to analyze`);\n    \n    for (const file of files) {\n      await this.analyzeFile(file);\n    }\n    \n    console.log(`\\n‚úÖ Analysis complete: Found ${this.usages.length} Supabase operations`);\n  }\n  \n  private async analyzeFile(filePath: string): Promise<void> {\n    try {\n      const content = fs.readFileSync(filePath, 'utf-8');\n      const lines = content.split('\\n');\n      \n      lines.forEach((line, index) => {\n        for (const { pattern, operation, replacement } of SUPABASE_PATTERNS) {\n          let match;\n          const regex = new RegExp(pattern.source, pattern.flags);\n          \n          while ((match = regex.exec(line)) !== null) {\n            const table = match[1];\n            const classification = TABLE_CLASSIFICATIONS[table] || 'metadata';\n            \n            this.usages.push({\n              file: filePath,\n              line: index + 1,\n              code: line.trim(),\n              table,\n              operation,\n              migrationSuggestion: replacement\n                .replace('auto-detected', classification)\n                .replace('$1', table)\n            });\n          }\n        }\n      });\n      \n    } catch (error) {\n      console.error(`Error analyzing ${filePath}:`, error);\n    }\n  }\n  \n  generateMigrationPlan(): void {\n    console.log('\\nüìã MIGRATION PLAN\\n');\n    console.log('=' .repeat(80));\n    \n    // Group by file\n    const byFile = this.groupBy(this.usages, 'file');\n    \n    Object.entries(byFile).forEach(([file, usages]) => {\n      console.log(`\\nüìÅ ${file}`);\n      console.log('-'.repeat(60));\n      \n      usages.forEach((usage, index) => {\n        console.log(`\\n${index + 1}. Line ${usage.line} (${usage.operation} on ${usage.table})`);\n        console.log(`   Current:    ${usage.code}`);\n        console.log(`   Suggested:  ${usage.migrationSuggestion}`);\n      });\n    });\n    \n    // Summary statistics\n    const stats = this.calculateStats();\n    console.log('\\nüìä MIGRATION STATISTICS\\n');\n    console.log('=' .repeat(50));\n    console.log(`Total Operations:     ${stats.totalOperations}`);\n    console.log(`Files Affected:       ${stats.filesAffected}`);\n    console.log(`Tables Accessed:      ${stats.uniqueTables}`);\n    console.log(`\\nOperations by Type:`);\n    Object.entries(stats.operationTypes).forEach(([op, count]) => {\n      console.log(`  ${op.padEnd(10)}: ${count}`);\n    });\n    console.log(`\\nTables by Classification:`);\n    Object.entries(stats.tableClassifications).forEach(([classification, tables]) => {\n      console.log(`  ${classification.padEnd(15)}: ${tables.join(', ')}`);\n    });\n  }\n  \n  generateAutomaticMigration(): void {\n    console.log('\\nü§ñ GENERATING AUTOMATIC MIGRATION...\\n');\n    \n    const byFile = this.groupBy(this.usages, 'file');\n    let migratedFiles = 0;\n    \n    Object.entries(byFile).forEach(([filePath, usages]) => {\n      try {\n        let content = fs.readFileSync(filePath, 'utf-8');\n        let modified = false;\n        \n        // Check if file already imports secureSupabase\n        if (!content.includes('secureSupabase')) {\n          // Add import at the top\n          const importLine = \"import { secureSupabase } from '@/lib/database';\";\n          \n          if (content.includes(\"from '@/lib/supabase'\")) {\n            content = content.replace(\n              /import .* from '@\\/lib\\/supabase';/g,\n              `$&\\n${importLine}`\n            );\n          } else {\n            // Add after other imports\n            const lines = content.split('\\n');\n            const lastImportIndex = lines.findIndex(line => \n              line.startsWith('import') && !lines[lines.indexOf(line) + 1]?.startsWith('import')\n            );\n            \n            if (lastImportIndex >= 0) {\n              lines.splice(lastImportIndex + 1, 0, importLine);\n              content = lines.join('\\n');\n            }\n          }\n          modified = true;\n        }\n        \n        // Replace supabase calls with secureSupabase calls\n        usages.forEach(usage => {\n          const oldPattern = usage.code;\n          const newCode = usage.migrationSuggestion;\n          \n          // Simple replacement - in production, you'd want more sophisticated AST parsing\n          content = content.replace(oldPattern, newCode);\n          modified = true;\n        });\n        \n        if (modified) {\n          // Write backup\n          const backupPath = `${filePath}.backup.${Date.now()}`;\n          fs.writeFileSync(backupPath, fs.readFileSync(filePath));\n          \n          // Write migrated file\n          fs.writeFileSync(filePath, content);\n          \n          console.log(`‚úÖ Migrated: ${filePath} (backup: ${backupPath})`);\n          migratedFiles++;\n        }\n        \n      } catch (error) {\n        console.error(`‚ùå Failed to migrate ${filePath}:`, error);\n      }\n    });\n    \n    console.log(`\\nüéâ Migration complete: ${migratedFiles} files migrated`);\n    console.log('\\n‚ö†Ô∏è  IMPORTANT NEXT STEPS:');\n    console.log('1. Review all migrated files manually');\n    console.log('2. Update data classifications as needed');\n    console.log('3. Add proper error handling');\n    console.log('4. Test all modified endpoints');\n    console.log('5. Remove backup files when satisfied');\n  }\n  \n  private groupBy<T>(array: T[], key: keyof T): Record<string, T[]> {\n    return array.reduce((groups, item) => {\n      const group = String(item[key]);\n      groups[group] = groups[group] || [];\n      groups[group].push(item);\n      return groups;\n    }, {} as Record<string, T[]>);\n  }\n  \n  private calculateStats() {\n    const operationTypes: Record<string, number> = {};\n    const tableClassifications: Record<string, string[]> = {};\n    const uniqueTables = new Set<string>();\n    const uniqueFiles = new Set<string>();\n    \n    this.usages.forEach(usage => {\n      if (usage.operation) {\n        operationTypes[usage.operation] = (operationTypes[usage.operation] || 0) + 1;\n      }\n      \n      if (usage.table) {\n        uniqueTables.add(usage.table);\n        const classification = TABLE_CLASSIFICATIONS[usage.table] || 'metadata';\n        \n        if (!tableClassifications[classification]) {\n          tableClassifications[classification] = [];\n        }\n        \n        if (!tableClassifications[classification].includes(usage.table)) {\n          tableClassifications[classification].push(usage.table);\n        }\n      }\n      \n      uniqueFiles.add(usage.file);\n    });\n    \n    return {\n      totalOperations: this.usages.length,\n      filesAffected: uniqueFiles.size,\n      uniqueTables: uniqueTables.size,\n      operationTypes,\n      tableClassifications\n    };\n  }\n}\n\n// CLI interface\nasync function main() {\n  const args = process.argv.slice(2);\n  const command = args[0] || 'analyze';\n  const sourceDir = args[1] || 'src';\n  \n  const migrator = new SupabaseMigrator(sourceDir);\n  \n  await migrator.analyzeCodebase();\n  \n  switch (command) {\n    case 'analyze':\n      migrator.generateMigrationPlan();\n      break;\n      \n    case 'migrate':\n      migrator.generateMigrationPlan();\n      console.log('\\n‚ö†Ô∏è  Are you sure you want to proceed with automatic migration?');\n      console.log('This will modify your source files (backups will be created).');\n      console.log('\\nRun with --confirm to proceed:');\n      console.log('npm run migrate-supabase migrate --confirm');\n      \n      if (args.includes('--confirm')) {\n        migrator.generateAutomaticMigration();\n      }\n      break;\n      \n    default:\n      console.log('Usage: npm run migrate-supabase [analyze|migrate] [source-dir]');\n      console.log('\\nCommands:');\n      console.log('  analyze  - Analyze codebase and show migration plan (default)');\n      console.log('  migrate  - Perform automatic migration with backups');\n      break;\n  }\n}\n\nif (require.main === module) {\n  main().catch(console.error);\n}\n\nexport { SupabaseMigrator };