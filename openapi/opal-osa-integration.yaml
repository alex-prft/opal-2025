openapi: 3.0.0
info:
  title: OPAL Decision & Diagnostics API
  version: 1.0.0
  description: |
    Complete API specification for OPAL â†’ OSA data flow, decision-making, and troubleshooting.

    This API maintains backward compatibility with existing OPAL integrations while providing
    enhanced decision layer capabilities with evidence-based recommendations, confidence scoring,
    and impact/effort analysis.

    **Key Features:**
    - Idempotent webhook processing for reliable data flow
    - Evidence-based decision making with confidence metrics
    - Comprehensive diagnostics and troubleshooting tools
    - Force sync and orchestration capabilities
    - Backward compatible with existing OPAL workflows
  contact:
    name: OPAL Development Team
    url: https://opal-2025.vercel.app
  license:
    name: MIT

servers:
  - url: http://localhost:3000
    description: Local development server
  - url: https://opal-2025.vercel.app
    description: Production server

paths:
  /api/orchestrations/trigger:
    post:
      tags:
        - Orchestration
      summary: Trigger a strategy workflow
      description: |
        Initiates a strategy workflow execution (Force Sync functionality).

        This endpoint maintains compatibility with existing OPAL orchestration
        flows while providing enhanced tracking and monitoring capabilities.
      operationId: triggerWorkflow
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowTriggerRequest'
            examples:
              force_sync:
                summary: Force sync workflow trigger
                value:
                  strategy_assistant_workflow: "workflow-force-sync-2025"
                  trigger_source: "manual"
                  priority: "high"
              scheduled_sync:
                summary: Scheduled workflow trigger
                value:
                  strategy_assistant_workflow: "workflow-scheduled-sync-2025"
                  trigger_source: "scheduler"
                  priority: "normal"
      responses:
        '200':
          description: Workflow triggered successfully
          headers:
            X-Correlation-ID:
              schema:
                type: string
              description: Request correlation ID for tracing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowTriggerResponse'
              example:
                success: true
                data:
                  execution_id: "exec-1699876543210-abc123"
                  workflow_id: "workflow-force-sync-2025"
                  status: "initiated"
                  estimated_duration_minutes: 15
                correlation_id: "api-1699876543210-def456"
                timestamp: "2025-11-12T15:45:00.000Z"
                duration_ms: 89
        '400':
          $ref: '#/components/responses/ValidationError'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/webhooks/opal-workflow:
    post:
      tags:
        - Webhooks
      summary: Idempotent receiver for OPAL agent webhook events
      description: |
        Receives and processes webhook events from OPAL agents with idempotency guarantees.

        **Idempotency:** Duplicate events with the same workflow_id + agent_id + offset
        combination are safely ignored to prevent data corruption.

        **Backward Compatibility:** Maintains existing webhook signature validation
        and processing flows while adding enhanced monitoring and diagnostics.
      operationId: receiveOpalWebhook
      security:
        - hmacSignature: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OpalWebhookEvent'
            examples:
              success_event:
                summary: Successful agent execution
                value:
                  workflow_id: "wf-content-audit-2025"
                  agent_id: "content_review"
                  execution_status: "success"
                  agent_data:
                    findings_count: 47
                    issues_identified: 3
                    confidence_score: 0.89
                  offset: 1
                  timestamp: "2025-11-12T15:30:00.000Z"
              failure_event:
                summary: Failed agent execution
                value:
                  workflow_id: "wf-audience-analysis-2025"
                  agent_id: "audience_suggester"
                  execution_status: "failure"
                  error_details:
                    error_code: "DATA_ACCESS_ERROR"
                    error_message: "Unable to access customer data source"
                  offset: 2
                  timestamp: "2025-11-12T15:35:00.000Z"
      responses:
        '202':
          description: Webhook accepted for processing
          headers:
            X-Correlation-ID:
              schema:
                type: string
              description: Request correlation ID for tracing
            X-Idempotency-Key:
              schema:
                type: string
              description: Idempotency key for duplicate detection
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookResponse'
              example:
                success: true
                message: "Webhook event processed successfully"
                data:
                  event_id: "evt-1699876543210-xyz789"
                  workflow_id: "wf-content-audit-2025"
                  agent_id: "content_review"
                  processing_status: "accepted"
                  duplicate_detected: false
                correlation_id: "api-1699876543210-abc123"
                timestamp: "2025-11-12T15:30:05.000Z"
                duration_ms: 45
        '400':
          description: Invalid webhook payload or signature
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid or missing webhook signature
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Duplicate event detected (idempotency conflict)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/diagnostics/last-webhook:
    get:
      tags:
        - Diagnostics
      summary: Retrieve recent webhook events for troubleshooting
      description: |
        Provides comprehensive webhook event history for debugging and monitoring.

        **Use Cases:**
        - Troubleshooting failed webhook deliveries
        - Monitoring agent execution patterns
        - Validating webhook signature processing
        - Identifying duplicate or missing events
      operationId: getWebhookDiagnostics
      parameters:
        - name: limit
          in: query
          description: Maximum number of events to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 25
        - name: status
          in: query
          description: Filter events by execution status
          schema:
            type: string
            enum: [success, failure, timeout, all]
            default: all
        - name: workflow_id
          in: query
          description: Filter events by specific workflow
          schema:
            type: string
        - name: agent_id
          in: query
          description: Filter events by specific agent
          schema:
            type: string
            enum: [experiment_blueprinter, audience_suggester, content_review, roadmap_generator, integration_health, personalization_idea_generator, cmp_organizer, customer_journey, geo_audit]
        - name: hours
          in: query
          description: Number of hours to look back
          schema:
            type: integer
            minimum: 1
            maximum: 168
            default: 24
      responses:
        '200':
          description: List of recent webhook events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookDiagnosticsResponse'
              example:
                success: true
                data:
                  events:
                    - event_id: "evt-1699876543210-abc123"
                      workflow_id: "wf-content-audit-2025"
                      agent_id: "content_review"
                      execution_status: "success"
                      received_at: "2025-11-12T15:30:00.000Z"
                      http_status: 202
                      signature_valid: true
                      processing_time_ms: 45
                      duplicate_detected: false
                    - event_id: "evt-1699876543205-def456"
                      workflow_id: "wf-audience-analysis-2025"
                      agent_id: "audience_suggester"
                      execution_status: "failure"
                      received_at: "2025-11-12T15:25:00.000Z"
                      http_status: 202
                      signature_valid: true
                      processing_time_ms: 89
                      error_details:
                        error_code: "DATA_ACCESS_ERROR"
                        error_message: "Unable to access customer data source"
                  metadata:
                    total_events: 2
                    success_rate: "50.0%"
                    time_range: "2025-11-11T15:30:00.000Z to 2025-11-12T15:30:00.000Z"
                correlation_id: "api-1699876543210-ghi789"
                timestamp: "2025-11-12T15:45:00.000Z"
                duration_ms: 156
        '400':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/recommendations:
    post:
      tags:
        - Decision Layer
      summary: Generate ranked recommendations based on workflow and preferences
      description: |
        Core decision-making endpoint that processes OPAL agent outputs to generate
        intelligent, evidence-based recommendations with confidence scoring and
        impact/effort analysis.

        **Key Features:**
        - Evidence from all 9 OPAL agent types
        - Confidence scoring with data quality and consensus breakdown
        - Impact vs effort analysis with combined ratios
        - Risk tolerance filtering
        - Priority weight-based ranking
        - Business objective alignment
        - Timeline estimation and risk assessment
      operationId: generateRecommendations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DecisionParameters'
            examples:
              conversion_optimization:
                summary: Conversion-focused recommendations
                value:
                  workflow_id: "wf-conversion-optimization-2025"
                  preferences:
                    priority_weights:
                      impact: 0.7
                      effort: 0.3
                    risk_tolerance: "medium"
                    business_objectives: ["conversion", "revenue"]
                    timeline_constraints:
                      start_date: "2025-11-12T00:00:00Z"
                      end_date: "2025-12-31T00:00:00Z"
              balanced_approach:
                summary: Balanced multi-objective optimization
                value:
                  workflow_id: "wf-balanced-optimization-2025"
                  preferences:
                    priority_weights:
                      impact: 0.5
                      effort: 0.5
                    risk_tolerance: "medium"
                    business_objectives: ["conversion", "retention", "performance", "acquisition"]
                    timeline_constraints:
                      start_date: "2025-11-20T00:00:00Z"
                      end_date: "2026-02-20T00:00:00Z"
      responses:
        '200':
          description: Successfully generated recommendations
          headers:
            X-Correlation-ID:
              schema:
                type: string
              description: Request correlation ID for tracing
            X-Response-Time:
              schema:
                type: string
              description: Processing time in milliseconds
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecommendationsResponse'
              example:
                success: true
                data:
                  workflow_id: "wf-conversion-optimization-2025"
                  workflow_state: "in-progress"
                  recommendations:
                    - id: "rec-1699876543210-abc123"
                      title: "Optimize Call-to-Action Placement"
                      description: "Move primary CTAs above the fold to increase visibility and conversions"
                      impact: 8
                      effort: 3
                      combined_ratio: 2.67
                      confidence: 0.89
                      confidence_breakdown:
                        data_quality: 0.91
                        agent_consensus: 0.87
                      category: "High"
                      evidence:
                        - agent_type: "content_review"
                          data_source: "Content Management System"
                          confidence: 0.91
                          timestamp: "2025-11-12T10:00:00Z"
                          summary: "Content analysis identifies engagement improvement areas"
                        - agent_type: "customer_journey"
                          data_source: "Journey Analytics"
                          confidence: 0.87
                          timestamp: "2025-11-12T09:30:00Z"
                          summary: "Journey mapping reveals friction points to address"
                      tags: ["CTA", "conversion optimization", "UX"]
                      estimated_timeline: "2 weeks (2025-11-12 to 2025-11-26)"
                      risk_level: "low"
                  metadata:
                    total_recommendations: 1
                    generated_at: "2025-11-12T15:45:00.000Z"
                    processing_time_ms: 245
                    agent_data_freshness:
                      oldest_evidence: "2025-11-12T09:30:00Z"
                      newest_evidence: "2025-11-12T10:00:00Z"
                correlation_id: "api-1699876543210-def456"
                timestamp: "2025-11-12T15:45:00.000Z"
                duration_ms: 245
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          description: Workflow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalError'

    get:
      tags:
        - Documentation
      summary: API documentation and examples
      description: Returns comprehensive API documentation, sample requests, and supported parameters
      operationId: getRecommendationsDocumentation
      responses:
        '200':
          description: API documentation and examples
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiDocumentation'

  /api/orchestrations/replay:
    post:
      tags:
        - Orchestration
      summary: Replay failed or incomplete workflow executions
      description: |
        Allows replaying of failed or incomplete workflow executions for recovery
        and troubleshooting purposes. Maintains idempotency and event ordering.
      operationId: replayWorkflow
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowReplayRequest'
      responses:
        '200':
          description: Replay initiated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowReplayResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          description: Original workflow execution not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  schemas:
    # Core Data Types
    OpalAgentType:
      type: string
      enum:
        - experiment_blueprinter
        - audience_suggester
        - content_review
        - roadmap_generator
        - integration_health
        - personalization_idea_generator
        - cmp_organizer
        - customer_journey
        - geo_audit
      description: Supported OPAL agent types

    ExecutionStatus:
      type: string
      enum: [success, failure, timeout]
      description: Webhook event execution status

    RiskTolerance:
      type: string
      enum: [low, medium, high]
      description: Risk tolerance level for recommendations

    BusinessObjective:
      type: string
      enum: [conversion, retention, engagement, acquisition, revenue, personalization, experience, performance]
      description: Business objectives to optimize for

    WorkflowState:
      type: string
      enum: [in-progress, completed, failed, pending]
      description: Current state of workflow execution

    # Request Schemas
    WorkflowTriggerRequest:
      type: object
      required:
        - strategy_assistant_workflow
      properties:
        strategy_assistant_workflow:
          type: string
          description: Unique identifier for the workflow to trigger
          example: "workflow-force-sync-2025"
        trigger_source:
          type: string
          enum: [manual, scheduler, api, webhook]
          description: Source that initiated the workflow trigger
          default: "api"
        priority:
          type: string
          enum: [low, normal, high, critical]
          description: Execution priority level
          default: "normal"
        context:
          type: object
          description: Additional context data for workflow execution
          additionalProperties: true

    OpalWebhookEvent:
      type: object
      required:
        - workflow_id
        - agent_id
        - execution_status
        - offset
      properties:
        workflow_id:
          type: string
          description: Unique identifier for the workflow
          example: "wf-content-audit-2025"
        agent_id:
          $ref: '#/components/schemas/OpalAgentType'
        execution_status:
          $ref: '#/components/schemas/ExecutionStatus'
        agent_data:
          type: object
          description: Agent-specific execution results and data
          additionalProperties: true
        error_details:
          type: object
          description: Error information (present when execution_status is failure)
          properties:
            error_code:
              type: string
              description: Machine-readable error code
            error_message:
              type: string
              description: Human-readable error description
            stack_trace:
              type: string
              description: Technical stack trace (development only)
        offset:
          type: integer
          minimum: 0
          description: Event sequence number for idempotency and ordering
        timestamp:
          type: string
          format: date-time
          description: Event generation timestamp (ISO 8601)
        retry_count:
          type: integer
          minimum: 0
          description: Number of previous retry attempts
          default: 0

    DecisionParameters:
      type: object
      required:
        - workflow_id
        - preferences
      properties:
        workflow_id:
          type: string
          minLength: 1
          description: Unique identifier for the OPAL workflow
          example: "wf-conversion-optimization-2025"
        preferences:
          $ref: '#/components/schemas/DecisionPreferences'

    DecisionPreferences:
      type: object
      required:
        - priority_weights
        - risk_tolerance
        - business_objectives
        - timeline_constraints
      properties:
        priority_weights:
          $ref: '#/components/schemas/PriorityWeights'
        risk_tolerance:
          $ref: '#/components/schemas/RiskTolerance'
        business_objectives:
          type: array
          items:
            $ref: '#/components/schemas/BusinessObjective'
          minItems: 1
          description: Business objectives to optimize for
          example: ["conversion", "engagement"]
        timeline_constraints:
          $ref: '#/components/schemas/TimelineConstraints'

    PriorityWeights:
      type: object
      required:
        - impact
        - effort
      properties:
        impact:
          type: number
          minimum: 0
          maximum: 1
          description: Weight for impact scoring (must sum with effort to 1.0)
          example: 0.7
        effort:
          type: number
          minimum: 0
          maximum: 1
          description: Weight for effort scoring (must sum with impact to 1.0)
          example: 0.3
      description: Priority weights must sum to 1.0

    TimelineConstraints:
      type: object
      required:
        - start_date
        - end_date
      properties:
        start_date:
          type: string
          format: date-time
          description: Project start date (ISO 8601 format)
          example: "2025-11-12T00:00:00Z"
        end_date:
          type: string
          format: date-time
          description: Project end date (ISO 8601 format)
          example: "2025-12-12T00:00:00Z"

    WorkflowReplayRequest:
      type: object
      required:
        - execution_id
      properties:
        execution_id:
          type: string
          description: Original execution ID to replay
        from_offset:
          type: integer
          minimum: 0
          description: Starting offset for replay (0 = full replay)
          default: 0
        agent_filter:
          type: array
          items:
            $ref: '#/components/schemas/OpalAgentType'
          description: Specific agents to replay (empty = all agents)

    # Response Schemas
    WorkflowTriggerResponse:
      allOf:
        - $ref: '#/components/schemas/StandardApiResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                execution_id:
                  type: string
                  description: Unique execution identifier
                  example: "exec-1699876543210-abc123"
                workflow_id:
                  type: string
                  description: Workflow identifier that was triggered
                status:
                  type: string
                  enum: [initiated, queued, running]
                  description: Current execution status
                estimated_duration_minutes:
                  type: integer
                  minimum: 1
                  description: Estimated completion time in minutes

    WebhookResponse:
      allOf:
        - $ref: '#/components/schemas/StandardApiResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                event_id:
                  type: string
                  description: Unique event identifier
                workflow_id:
                  type: string
                  description: Workflow identifier from webhook
                agent_id:
                  $ref: '#/components/schemas/OpalAgentType'
                processing_status:
                  type: string
                  enum: [accepted, rejected, duplicate]
                  description: Webhook processing result
                duplicate_detected:
                  type: boolean
                  description: Whether this was a duplicate event

    WebhookDiagnosticsResponse:
      allOf:
        - $ref: '#/components/schemas/StandardApiResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                events:
                  type: array
                  items:
                    $ref: '#/components/schemas/WebhookEventSummary'
                metadata:
                  type: object
                  properties:
                    total_events:
                      type: integer
                      description: Total number of events in response
                    success_rate:
                      type: string
                      description: Percentage of successful events
                      example: "85.2%"
                    time_range:
                      type: string
                      description: Time range covered by results
                      example: "2025-11-11T15:30:00.000Z to 2025-11-12T15:30:00.000Z"

    WebhookEventSummary:
      type: object
      properties:
        event_id:
          type: string
          description: Unique event identifier
        workflow_id:
          type: string
          description: Associated workflow identifier
        agent_id:
          $ref: '#/components/schemas/OpalAgentType'
        execution_status:
          $ref: '#/components/schemas/ExecutionStatus'
        received_at:
          type: string
          format: date-time
          description: When the webhook was received
        http_status:
          type: integer
          description: HTTP status code returned to sender
        signature_valid:
          type: boolean
          description: Whether webhook signature was valid
        processing_time_ms:
          type: integer
          description: Time taken to process the webhook
        duplicate_detected:
          type: boolean
          description: Whether this was identified as a duplicate
        error_details:
          type: object
          description: Error information (if applicable)
          properties:
            error_code:
              type: string
            error_message:
              type: string

    RecommendationsResponse:
      allOf:
        - $ref: '#/components/schemas/StandardApiResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                workflow_id:
                  type: string
                  description: Associated workflow identifier
                workflow_state:
                  $ref: '#/components/schemas/WorkflowState'
                recommendations:
                  type: array
                  items:
                    $ref: '#/components/schemas/Recommendation'
                  description: Ranked list of recommendations
                metadata:
                  $ref: '#/components/schemas/RecommendationMetadata'

    Recommendation:
      type: object
      required:
        - title
        - impact
        - effort
        - combined_ratio
        - confidence
        - confidence_breakdown
        - evidence
      properties:
        id:
          type: string
          description: Unique recommendation identifier
          example: "rec-1699876543210-abc123"
        title:
          type: string
          description: Recommendation title
          example: "Optimize Call-to-Action Placement"
        description:
          type: string
          description: Detailed recommendation description
          example: "Move primary CTAs above the fold to increase visibility and conversions"
        impact:
          type: integer
          minimum: 1
          maximum: 10
          description: Expected impact score (1-10 scale)
          example: 8
        effort:
          type: integer
          minimum: 1
          maximum: 10
          description: Implementation effort score (1-10 scale)
          example: 3
        combined_ratio:
          type: number
          minimum: 0
          description: Impact to effort ratio (impact / effort)
          example: 2.67
        confidence:
          type: number
          minimum: 0
          maximum: 1
          description: Overall confidence score (0-1 scale)
          example: 0.89
        confidence_breakdown:
          $ref: '#/components/schemas/ConfidenceBreakdown'
        category:
          type: string
          enum: [High, Medium, Low]
          description: Priority category based on impact/effort ratio
          example: "High"
        evidence:
          type: array
          items:
            $ref: '#/components/schemas/EvidenceItem'
          minItems: 1
          description: Supporting evidence from OPAL agents
        tags:
          type: array
          items:
            type: string
          description: Recommendation tags
          example: ["CTA", "conversion optimization", "UX"]
        estimated_timeline:
          type: string
          description: Estimated implementation timeline
          example: "2 weeks (2025-11-12 to 2025-11-26)"
        risk_level:
          $ref: '#/components/schemas/RiskTolerance'

    ConfidenceBreakdown:
      type: object
      required:
        - data_quality
        - agent_consensus
      properties:
        data_quality:
          type: number
          minimum: 0
          maximum: 1
          description: Quality of underlying data (0-1 scale)
          example: 0.91
        agent_consensus:
          type: number
          minimum: 0
          maximum: 1
          description: Level of agreement between agents (0-1 scale)
          example: 0.87

    EvidenceItem:
      type: object
      required:
        - agent_type
        - data_source
        - confidence
        - timestamp
        - summary
      properties:
        agent_type:
          $ref: '#/components/schemas/OpalAgentType'
        data_source:
          type: string
          description: Source system or database
          example: "Content Management System"
        confidence:
          type: number
          minimum: 0
          maximum: 1
          description: Confidence level of this evidence (0-1 scale)
          example: 0.91
        timestamp:
          type: string
          format: date-time
          description: When this evidence was collected (ISO 8601 format)
          example: "2025-11-12T10:00:00Z"
        summary:
          type: string
          maxLength: 500
          description: Brief summary of the evidence
          example: "Content analysis identifies engagement improvement areas"

    RecommendationMetadata:
      type: object
      properties:
        total_recommendations:
          type: integer
          minimum: 0
          description: Total number of recommendations generated
        generated_at:
          type: string
          format: date-time
          description: Generation timestamp
        processing_time_ms:
          type: integer
          minimum: 0
          description: Processing time in milliseconds
        agent_data_freshness:
          type: object
          description: Information about agent data recency
          properties:
            oldest_evidence:
              type: string
              format: date-time
              description: Timestamp of oldest evidence used
            newest_evidence:
              type: string
              format: date-time
              description: Timestamp of newest evidence used

    WorkflowReplayResponse:
      allOf:
        - $ref: '#/components/schemas/StandardApiResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                replay_execution_id:
                  type: string
                  description: New execution ID for the replay
                original_execution_id:
                  type: string
                  description: Original execution ID that was replayed
                replay_status:
                  type: string
                  enum: [initiated, queued, running]
                events_to_replay:
                  type: integer
                  description: Number of events scheduled for replay

    ApiDocumentation:
      type: object
      properties:
        endpoint:
          type: string
          example: "/api/recommendations"
        description:
          type: string
        version:
          type: string
          example: "1.0.0"
        methods:
          type: object
          description: Supported HTTP methods and their details
        features:
          type: array
          items:
            type: string
          description: List of key features
        agent_types:
          type: array
          items:
            $ref: '#/components/schemas/OpalAgentType'
        business_objectives:
          type: array
          items:
            $ref: '#/components/schemas/BusinessObjective'
        risk_tolerance_levels:
          type: array
          items:
            $ref: '#/components/schemas/RiskTolerance'
        sample_curl:
          type: string
          description: Example curl command

    # Standard Response Schemas
    StandardApiResponse:
      type: object
      required:
        - success
        - correlation_id
        - timestamp
      properties:
        success:
          type: boolean
          description: Whether the request was successful
          example: true
        data:
          description: Response data (varies by endpoint)
        message:
          type: string
          description: Optional human-readable message
        correlation_id:
          type: string
          description: Unique request identifier for tracing
          example: "api-1699876543210-def456"
        timestamp:
          type: string
          format: date-time
          description: Response generation timestamp (ISO 8601 format)
          example: "2025-11-12T15:45:00.000Z"
        duration_ms:
          type: integer
          minimum: 0
          description: Processing time in milliseconds
          example: 245

    ErrorResponse:
      type: object
      required:
        - success
        - error
        - message
        - correlation_id
        - timestamp
      properties:
        success:
          type: boolean
          description: Always false for error responses
          example: false
        error:
          type: string
          description: Error code
          example: "VALIDATION_ERROR"
        message:
          type: string
          description: Human-readable error description
          example: "Invalid request body"
        correlation_id:
          type: string
          description: Unique request identifier for tracing
          example: "api-1699876543210-def456"
        timestamp:
          type: string
          format: date-time
          description: Error occurrence timestamp (ISO 8601 format)
          example: "2025-11-12T15:45:00.000Z"
        duration_ms:
          type: integer
          minimum: 0
          description: Processing time before error occurred
          example: 25
        data:
          description: Additional error details (only in development)

  securitySchemes:
    hmacSignature:
      type: apiKey
      in: header
      name: X-Signature-SHA256
      description: |
        HMAC-SHA256 signature for webhook authentication.

        Format: sha256=<hex_digest>

        The signature is computed using the raw request body and a shared secret key.

  responses:
    ValidationError:
      description: Request validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: "VALIDATION_ERROR"
            message: "Invalid request body"
            correlation_id: "api-1699876543210-def456"
            timestamp: "2025-11-12T15:45:00.000Z"
            duration_ms: 25

    RateLimitExceeded:
      description: Too many requests
      headers:
        Retry-After:
          schema:
            type: integer
          description: Seconds to wait before retrying
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: "RATE_LIMIT_EXCEEDED"
            message: "Rate limit exceeded. Please retry after 60 seconds."
            correlation_id: "api-1699876543210-def456"
            timestamp: "2025-11-12T15:45:00.000Z"
            duration_ms: 5

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: "INTERNAL_SERVER_ERROR"
            message: "An unexpected error occurred"
            correlation_id: "api-1699876543210-def456"
            timestamp: "2025-11-12T15:45:00.000Z"
            duration_ms: 150

tags:
  - name: Orchestration
    description: Workflow triggering and management
  - name: Webhooks
    description: OPAL agent event processing with idempotency
  - name: Diagnostics
    description: Troubleshooting and monitoring tools
  - name: Decision Layer
    description: Intelligent recommendation generation based on OPAL agent outputs
  - name: Documentation
    description: API documentation and examples