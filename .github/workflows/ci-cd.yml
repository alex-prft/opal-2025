name: OSA Platform CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  NODE_VERSION: 18

jobs:
  # ============================================================================
  # Code Quality and Testing
  # ============================================================================

  quality-check:
    name: Code Quality & Testing
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Type check
        run: npm run type-check

      - name: Lint code
        run: npm run lint

      - name: Format check
        run: npm run format:check

      - name: Run API tests (Jest)
        run: npm test -- --coverage --ci --watchAll=false
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379
          OPAL_API_BASE: ${{ secrets.OPAL_API_BASE || 'https://api.opal.optimizely.com' }}
          OPAL_API_KEY: ${{ secrets.OPAL_API_KEY || 'test-api-key' }}
          OPAL_WORKSPACE_ID: ${{ secrets.OPAL_WORKSPACE_ID || 'test-workspace' }}
          OPAL_STRATEGY_WORKFLOW_AUTH_KEY: ${{ secrets.OPAL_STRATEGY_WORKFLOW_AUTH_KEY || 'test-auth-key' }}
          OSA_WEBHOOK_SHARED_SECRET: ${{ secrets.OSA_WEBHOOK_SHARED_SECRET || 'test-webhook-secret' }}

      - name: Run E2E tests (Playwright)
        run: npx playwright test --reporter=github
        env:
          NODE_ENV: test
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Generate test coverage
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

      - name: Security audit
        run: npm audit --audit-level=moderate

      - name: Dependency vulnerability scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium

  # ============================================================================
  # Contract Testing
  # ============================================================================

  contract-tests:
    name: Contract Testing
    runs-on: ubuntu-latest
    needs: quality-check
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run API contract tests
        run: npm run test:contracts
        env:
          PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_URL }}
          PACT_BROKER_TOKEN: ${{ secrets.PACT_BROKER_TOKEN }}

      - name: Validate OpenAPI schemas
        run: |
          npx swagger-codegen-cli validate -i docs/api-contracts/orchestration-api.yaml
          npx swagger-codegen-cli validate -i docs/api-contracts/recommendations-api.yaml
          npx swagger-codegen-cli validate -i docs/api-contracts/knowledge-retrieval-api.yaml

  # ============================================================================
  # Build and Push Container Images
  # ============================================================================

  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: [quality-check, contract-tests]
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tags: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
          labels: |
            org.opencontainers.image.title=OSA Platform
            org.opencontainers.image.description=Optimizely Strategy Assistant Platform
            org.opencontainers.image.vendor=Company Name

      - name: Build and push image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          target: production
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.version'] }}

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.spdx.json

  # ============================================================================
  # Security Scanning
  # ============================================================================

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-and-push
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Container security scan
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          args: --severity-threshold=high

  # ============================================================================
  # Deployment to Staging
  # ============================================================================

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-and-push, security-scan]
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://osa-staging.company.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Update ECS task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition osa-staging \
            --query taskDefinition > task-def.json

          jq '.containerDefinitions[0].image = "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"' \
            task-def.json > updated-task-def.json

      - name: Deploy to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: updated-task-def.json
          service: osa-staging
          cluster: osa-cluster
          wait-for-service-stability: true
          wait-for-minutes: 10

      - name: Run smoke tests
        run: |
          npm ci
          # Health endpoint smoke test
          curl -f https://osa-staging.company.com/api/opal/health || exit 1

          # Force sync endpoint smoke test
          curl -f https://osa-staging.company.com/api/force-sync/trigger || exit 1

          # Run Playwright smoke tests
          npx playwright test --project=chromium --grep "@smoke" --reporter=github
        env:
          PLAYWRIGHT_BASE_URL: https://osa-staging.company.com
          API_KEY: ${{ secrets.STAGING_API_KEY }}

      - name: Notify deployment
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: ":rocket: OSA Platform deployed to staging",
              attachments: [{
                color: "good",
                fields: [{
                  title: "Environment",
                  value: "Staging",
                  short: true
                }, {
                  title: "Version",
                  value: "${{ github.sha }}",
                  short: true
                }, {
                  title: "URL",
                  value: "https://osa-staging.company.com",
                  short: false
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ============================================================================
  # Deployment to Production
  # ============================================================================

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-push, security-scan]
    if: github.event_name == 'release' && github.event.action == 'published'
    environment:
      name: production
      url: https://osa.company.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Blue-Green deployment setup
        run: |
          # Get current service configuration
          aws ecs describe-services \
            --cluster osa-cluster \
            --services osa-production \
            --query 'services[0].taskDefinition' \
            --output text > current-task-def.txt

          # Create new task definition with new image
          aws ecs describe-task-definition \
            --task-definition osa-production \
            --query taskDefinition > task-def.json

          jq '.containerDefinitions[0].image = "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.release.tag_name }}"' \
            task-def.json > updated-task-def.json

      - name: Register new task definition
        run: |
          NEW_TASK_DEF=$(aws ecs register-task-definition \
            --cli-input-json file://updated-task-def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          echo "NEW_TASK_DEF_ARN=$NEW_TASK_DEF" >> $GITHUB_ENV

      - name: Create temporary green service
        run: |
          aws ecs create-service \
            --cluster osa-cluster \
            --service-name osa-production-green \
            --task-definition ${{ env.NEW_TASK_DEF_ARN }} \
            --desired-count 2 \
            --load-balancers targetGroupArn=${{ secrets.TARGET_GROUP_ARN }},containerName=osa-app,containerPort=3000 \
            --role ${{ secrets.ECS_SERVICE_ROLE }}

      - name: Wait for green service stability
        run: |
          aws ecs wait services-stable \
            --cluster osa-cluster \
            --services osa-production-green

      - name: Health check green deployment
        run: |
          # Wait for ALB to register targets
          sleep 60

          # Run health checks
          npm ci
          npm run test:smoke
        env:
          BASE_URL: https://osa.company.com
          API_KEY: ${{ secrets.PRODUCTION_API_KEY }}

      - name: Switch traffic to green (Blue-Green cutover)
        run: |
          # Update the main service to use new task definition
          aws ecs update-service \
            --cluster osa-cluster \
            --service osa-production \
            --task-definition ${{ env.NEW_TASK_DEF_ARN }}

          # Wait for update to complete
          aws ecs wait services-stable \
            --cluster osa-cluster \
            --services osa-production

      - name: Cleanup old blue service
        run: |
          # Delete the temporary green service
          aws ecs delete-service \
            --cluster osa-cluster \
            --service osa-production-green \
            --force

      - name: Post-deployment verification
        run: |
          # Final health checks
          npm run test:smoke

          # Check SLO compliance
          npm run check:slos
        env:
          BASE_URL: https://osa.company.com
          API_KEY: ${{ secrets.PRODUCTION_API_KEY }}
          PROMETHEUS_URL: ${{ secrets.PROMETHEUS_URL }}

      - name: Create deployment record
        run: |
          # Record deployment in monitoring system
          curl -X POST "${{ secrets.DEPLOYMENT_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "service": "osa-platform",
              "version": "${{ github.event.release.tag_name }}",
              "environment": "production",
              "deployed_by": "${{ github.actor }}",
              "commit_sha": "${{ github.sha }}",
              "deployed_at": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }'

      - name: Notify successful deployment
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: ":tada: OSA Platform successfully deployed to production",
              attachments: [{
                color: "good",
                fields: [{
                  title: "Version",
                  value: "${{ github.event.release.tag_name }}",
                  short: true
                }, {
                  title: "Environment",
                  value: "Production",
                  short: true
                }, {
                  title: "Deployed by",
                  value: "${{ github.actor }}",
                  short: true
                }, {
                  title: "URL",
                  value: "https://osa.company.com",
                  short: false
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, initiating rollback..."

          # Revert to previous task definition
          PREVIOUS_TASK_DEF=$(cat current-task-def.txt)
          aws ecs update-service \
            --cluster osa-cluster \
            --service osa-production \
            --task-definition $PREVIOUS_TASK_DEF

          # Notify about rollback
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "text": ":warning: OSA Platform deployment failed, rolled back to previous version",
              "username": "CI/CD Pipeline"
            }'

  # ============================================================================
  # Performance Testing
  # ============================================================================

  performance-test:
    name: Performance Testing
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install k6
        run: |
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run load tests
        run: |
          k6 run tests/performance/load-test.js \
            --env BASE_URL=https://osa-staging.company.com \
            --env API_KEY=${{ secrets.STAGING_API_KEY }}

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: performance-results.json

# ============================================================================
# Workflow Configuration
# ============================================================================

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true